% This is where the typesetting magic happens
% Please don't judge my latex - I'm an R person not a latex person
% I took a problem solving approach (ok i want to do this, next I want to do this)
% So it might not necessarily be the most coherent code
% and its cobbled together from a variety of places (mostly stack overflow)
% plus some help from AI

% Font settings

\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}

\setmainfont{SourceSerif4-Regular.ttf}[
  Path=\chrisdocfontpath,
  BoldFont=SourceSerif4-Bold.ttf,
  ItalicFont=SourceSerif4-Italic.ttf,
  BoldItalicFont=SourceSerif4-BoldItalic.ttf
]

\setsansfont{SourceSans3-Regular.ttf}[
  Path=\chrisdocfontpath,
  BoldFont=SourceSans3-Bold.ttf,
  ItalicFont=SourceSans3-Italic.ttf,
  BoldItalicFont=SourceSans3-BoldItalic.ttf,
  SemiboldFont=SourceSans3-Semibold.ttf,
  SemiboldItalicFont=SourceSans3-SemiboldItalic.ttf
]

% Stuff for typewrite fonts
\defaultfontfeatures{Scale=MatchLowercase}
\defaultfontfeatures[\rmfamily]{Ligatures=TeX}
\defaultfontfeatures[\sffamily]{Ligatures=TeX}

\setmonofont{SourceCodePro-Regular.ttf}[
  Path=\chrisdocfontpath,
  BoldFont=SourceCodePro-Bold.ttf,
  ItalicFont=SourceCodePro-Italic.ttf,
  RawFeature={-liga,-clig,-calt}
]

\usepackage{unicode-math}
\setmathfont{STIXTwoMath-Regular.ttf}[
Path=\chrisdocfontpath
]



% Font size + line spacing
\fontsize{12pt}{15.6pt}\selectfont

% Icons for cover page
\usepackage{fontawesome5}

% Footnote indentings
\usepackage[hang]{footmisc}      % already have this
\setlength{\footnotemargin}{.5em} % your preferred indent

% Tighter footnote vertical spacing
\setlength{\footnotesep}{0.5\baselineskip} % default ~0.6

% Reduce paragraph skip within a footnote
\setlength{\skip\footins}{6pt plus 2pt minus 1pt} % space above footnotes
\renewcommand{\footnotelayout}{\setlength{\parskip}{0pt}}

% Extra stuff for annoying cover page footnotes
\usepackage{etoolbox}
\makeatletter
\let\fm@makefntext\@makefntext
\patchcmd\maketitle{\if@twocolumn}{\let\@makefntext\fm@makefntext\if@twocolumn}{}{\fail}
\makeatother

% List spacing
\usepackage{enumitem}
\setlist{topsep = 0pt, itemsep = 0pt}

% Make all tabular environments use sans font by default

\AtBeginEnvironment{tabular}{\sffamily}
\AtBeginEnvironment{longtable}{\sffamily}
\AtBeginEnvironment{threeparttable}{\sffamily}
\AtBeginEnvironment{tabu}{\sffamily}
\AtBeginEnvironment{longtabu}{\sffamily}

\usepackage{siunitx}

% Make number columns follow the surrounding font and styles
\sisetup{
  detect-mode = true,
  detect-family = true,
  detect-weight = true,
  detect-shape = true
}

% Title stuff
\makeatletter

% Title fonts
\newfontfamily\TitleSans{SourceSans3-Semibold.ttf}[
  Path = \chrisdocfontpath,
  ItalicFont = SourceSans3-SemiboldItalic.ttf
]
\newfontfamily\SubtitleFont{SourceSans3-Regular.ttf}[
  Path = \chrisdocfontpath,
  BoldFont = SourceSans3-Bold.ttf,
  ItalicFont = SourceSans3-Italic.ttf,
  BoldItalicFont = SourceSans3-BoldItalic.ttf,
  LetterSpace = 1.5
]

% Title block spacing
\patchcmd{\@maketitle}{\begin{center}}{\begin{center}\vspace*{10em}}{}{}


% Title and subtitle formatting
\patchcmd{\@maketitle}{\@title}{{\TitleSans\fontsize{24}{6}\selectfont \@title}}{}{}

\providecommand{\subtitle}[1]{%
  \apptocmd{\@title}{%
    \par\vspace{0.15em}%
    {\SubtitleFont\LARGE #1}%
    \par\vspace{0.35em}%
  }{}{}%
}

\makeatother

% Abstract formatting

\makeatletter
\renewenvironment{abstract}{%
  \par\vspace{0.25\baselineskip}%
  \begingroup\setlength{\parindent}{0pt}\noindent\ignorespaces
}{%
  \par\endgroup\vspace{0.5\baselineskip}%
  \thispagestyle{cover}%
  \clearpage
  \pagenumbering{arabic}\setcounter{page}{1}%
}
\makeatother


% Title page note formatting
\makeatletter

% Take out date from title block
\patchcmd{\@maketitle}{\@date}{}{}{}

% Default if no TitlePageNote
\@ifundefined{TitlePageNote}{\newcommand{\TitlePageNote}{}}{}%

% Add extra notes after the author notes
\providecommand{\markerlessthanks}[1]{%
  \protected@xdef\@thanks{\@thanks\protect\footnotetext[0]{#1}}%
}

\patchcmd{\@maketitle}{\@author}{%
  \@author

  % TitlePageNote
  \ifx\TitlePageNote\@empty\else
    \markerlessthanks{\vspace*{-0.5\baselineskip}}
    \markerlessthanks{\TitlePageNote}%
  \fi
  % Version
  \ifx\@date\@empty\else
    \markerlessthanks{\vspace*{-0.5\baselineskip}}
    \markerlessthanks{\textbf{This version:} \@date}%
  \fi
}{}{}

\makeatother


% Cover status header stuff
\usepackage{xcolor}
\usepackage{fancyhdr}

\providecommand{\coverstatus}{}

\fancypagestyle{cover}{%
  \fancyhf{}%
  \renewcommand{\headrulewidth}{0pt}%
  \setlength{\headheight}{14pt}% ensure room for the header
  \lhead{%
    {\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont \coverstatus}%
  }%
}


\makeatletter
\pretocmd{\@maketitle}{\thispagestyle{cover}}{}{}
\makeatother


% Section header formatting
\usepackage{titlesec}

% Fonts
\titleformat{\section}
  {\sffamily\bfseries\Large}
  {\thesection}{0.75em}{}

\titleformat{\subsection}
  {\sffamily\bfseries\large}
  {\thesubsection}{0.6em}{}

\titleformat{\subsubsection}
 {\sffamily\fontseries{sb}\selectfont\normalsize}
 {\thesubsubsection}{0.5em}{}

% Spacing: left, before, after
\titlespacing*{\section}{0pt}{.8\baselineskip plus .2\baselineskip minus .2\baselineskip}{.2\baselineskip}
\titlespacing*{\subsection}{0pt}{0.4\baselineskip plus .1\baselineskip minus .1\baselineskip}{.1\baselineskip}
\titlespacing*{\subsubsection}{0pt}{0.2\baselineskip plus .05\baselineskip minus .05\baselineskip}{0\baselineskip}


% Captions
\usepackage{caption}
\usepackage{subcaption}

% Define a semibold font for caption labels
\DeclareCaptionFont{sb}{\fontseries{sb}\selectfont}

% Global caption style
\captionsetup{
  font       = {sf,small},
  labelfont  = {sf,sb},
  format     = plain,
  singlelinecheck = true, % controls short captions being centred
  labelsep   = colon,  % alternatives: period | space | endash | quad | newline
}

% Caption position
\captionsetup[table]{position=above}
\captionsetup[figure]{position=below}

% Subfigures formatted the same
\captionsetup[sub]{font={sf,small}, labelfont={sf,sb}, labelsep=colon}

% Stuff for appendix titling
\makeatletter

\newcommand{\MainTitle}{}

\AtBeginDocument{%
  \begingroup
  \long\def\extractfirst#1\par#2\END{\gdef\MainTitle{#1}}%
  \expandafter\extractfirst\@title\par\END
  \endgroup
}
\makeatother


% Fancy pagecount
\usepackage{lastpage}

\makeatletter
\AtBeginDocument{%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%

  % Main text: fancy or normal page number
  \fancypagestyle{fancy-main}{%
    \fancyhf{}%
    \ifdefined\usefancypagecount
      \fancyfoot[C]{Page \thepage\ of \pagerefLastMain}%
    \else
      \fancyfoot[C]{\thepage}%
    \fi
  }%

  % Appendix: fancy or normal page number
  \fancypagestyle{fancy-apdx}{%
    \fancyhf{}%
    \ifdefined\usefancypagecount
      \fancyfoot[C]{Appendix page \thepage\ of \pageref{LastPageAppendix}}%
    \else
      \fancyfoot[C]{\thepage}%
    \fi
  }%

  \pagestyle{fancy-main}%
}

% Capture appendix position and do page numbering things
\pretocmd{\appendix}{%
  \label{LastPageMain}
  \clearpage

  \setcounter{page}{1}%
  \ifdefined\usefancypagecount
    \renewcommand{\thepage}{\arabic{page}}%
    \providecommand{\theHpage}{}%
    \renewcommand{\theHpage}{app.\arabic{page}}%
  \else
    \renewcommand{\thepage}{A\arabic{page}}%
    \providecommand{\theHpage}{}%
    \renewcommand{\theHpage}{A\arabic{page}}%
  \fi

  \pagestyle{fancy-apdx}%
}{}{}

% Define last page depending on whether there's an appendix
\usepackage{lastpage}

\makeatletter
\newcommand*\pagerefLastMain{%
  \ifcsname r@LastPageMain\endcsname
    \pageref{LastPageMain}%
  \else
    \pageref{LastPage}%
  \fi}
\makeatother


% Headers - fill them in from the yaml
\providecommand{\MainHeaderOdd}{}
\providecommand{\MainHeaderEven}{}
\providecommand{\ApdxHeaderOdd}{}
\providecommand{\ApdxHeaderEven}{}

% If you want a headrule, change this in header-includes:
\providecommand{\SetHeadruleWidth}{0pt}

\makeatletter
\AtBeginDocument{%
  \renewcommand{\headrulewidth}{\SetHeadruleWidth}%
  \renewcommand{\footrulewidth}{0pt}%

% Header fonts
\fancypagestyle{fancy-main}{%
  \fancyhf{}%
  \fancyhead[CO]{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont \MainHeaderOdd}%
  \fancyhead[CE]{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont \MainHeaderEven}%
  % Clear the other header positions
  \fancyhead[LO,LE,RE,RO]{}%

  % Page formatting
  \ifdefined\usefancypagecount
    \fancyfoot[C]{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont{Page \thepage\ of \pagerefLastMain}}%
  \else
    \fancyfoot[C]{\thepage}%
  \fi
}%

% Appendix headers and page nubmers
\fancypagestyle{fancy-apdx}{%
  \fancyhf{}%

  \fancyhead[CO]{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont \ApdxHeaderOdd}%
  \fancyhead[CE]{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont \ApdxHeaderEven}%
  \fancyhead[LO,LE,RO,RE]{}%

  \ifdefined\usefancypagecount
    \fancyfoot[C]{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont {Appendix page \thepage\ of \pageref{LastPageAppendix}}}%
  \else
    \fancyfoot[C]{\thepage}%
  \fi
}%
  \pagestyle{fancy-main}%
}
\makeatother


% For demonstrating the header font
\newcommand{\headerdemo}[1]{{\sffamily\scshape\color{black!60}\fontsize{11}{12}\selectfont #1}}


% Label the final appendix page for page numbering
\AtEndDocument{\label{LastPageAppendix}}
\makeatother

% Custom code chunk colours
% Normal, 12 colours from https://tsitsul.in/blog/coloropt/
\definecolor{yellow}{rgb}{0.92,0.67,0.14}   % #ebac23
\definecolor{lipstick}{rgb}{0.72,0.00,0.35} % #b80058
\definecolor{azure}{rgb}{0.00,0.55,0.98}    % #008cf9
\definecolor{green}{rgb}{0.00,0.43,0.00}    % #006e00
\definecolor{caribbean}{rgb}{0.00,0.73,0.68}% #00bbad
\definecolor{lavender}{rgb}{0.82,0.39,0.90} % #d163e6
\definecolor{brown}{rgb}{0.70,0.27,0.01}    % #b24502
\definecolor{coral}{rgb}{1.00,0.57,0.53}    % #ff9287
\definecolor{indigo}{rgb}{0.35,0.33,0.84}   % #5954d6
\definecolor{turquoise}{rgb}{0.00,0.78,0.97}% #00c6f8
\definecolor{olive}{rgb}{0.53,0.52,0.00}    % #878500
\definecolor{jade}{rgb}{0.00,0.65,0.42}     % #00a76c
\definecolor{gray}{rgb}{0.74,0.74,0.74}     % #bdbdbd
\definecolor{black}{rgb}{0.00,0.00,0.00}   % #000000


% Background

\definecolor{shadecolor}{RGB}{248, 250, 252}

% Colour mapping
% Safe remaps for Pandoc highlighting macros â€” only redefine if they exist
\makeatletter
\@ifundefined{AlertTok}{}{\renewcommand{\AlertTok}[1]{\textcolor{lipstick}{\textbf{#1}}}}
\@ifundefined{AnnotationTok}{}{\renewcommand{\AnnotationTok}[1]{\textcolor{lipstick}{\textbf{\textit{#1}}}}}
\@ifundefined{AttributeTok}{}{\renewcommand{\AttributeTok}[1]{\textcolor{black}{#1}}}
\@ifundefined{BaseNTok}{}{\renewcommand{\BaseNTok}[1]{\textcolor{black}{#1}}}
\@ifundefined{BuiltInTok}{}{\renewcommand{\BuiltInTok}[1]{#1}}
\@ifundefined{CharTok}{}{\renewcommand{\CharTok}[1]{\textcolor{green}{#1}}}
\@ifundefined{CommentTok}{}{\renewcommand{\CommentTok}[1]{\textcolor{lipstick}{\textit{#1}}}}
\@ifundefined{CommentVarTok}{}{\renewcommand{\CommentVarTok}[1]{\textcolor{lipstick}{\textbf{\textit{#1}}}}}
\@ifundefined{ConstantTok}{}{\renewcommand{\ConstantTok}[1]{\textcolor{lipstick}{#1}}}
\@ifundefined{ControlFlowTok}{}{\renewcommand{\ControlFlowTok}[1]{\textcolor{azure}{\textbf{#1}}}}
\@ifundefined{DataTypeTok}{}{\renewcommand{\DataTypeTok}[1]{\textcolor{azure}{#1}}}
\@ifundefined{DecValTok}{}{\renewcommand{\DecValTok}[1]{\textcolor{black}{#1}}}
\@ifundefined{DocumentationTok}{}{\renewcommand{\DocumentationTok}[1]{\textcolor{lipstick}{\textbf{\textit{#1}}}}}
\@ifundefined{ErrorTok}{}{\renewcommand{\ErrorTok}[1]{\textcolor{yellow}{\textbf{#1}}}}
\@ifundefined{ExtensionTok}{}{\renewcommand{\ExtensionTok}[1]{#1}}
\@ifundefined{FloatTok}{}{\renewcommand{\FloatTok}[1]{\textcolor{black}{#1}}}
\@ifundefined{FunctionTok}{}{\renewcommand{\FunctionTok}[1]{\textcolor{azure}{#1}}}
\@ifundefined{ImportTok}{}{\renewcommand{\ImportTok}[1]{#1}}
\@ifundefined{InformationTok}{}{\renewcommand{\InformationTok}[1]{\textcolor{lipstick}{\textbf{\textit{#1}}}}}
\@ifundefined{KeywordTok}{}{\renewcommand{\KeywordTok}[1]{\textcolor{azure}{\textbf{#1}}}}
\@ifundefined{NormalTok}{}{\renewcommand{\NormalTok}[1]{#1}}
\@ifundefined{OperatorTok}{}{\renewcommand{\OperatorTok}[1]{\textcolor{black}{\textbf{#1}}}}
\@ifundefined{OtherTok}{}{\renewcommand{\OtherTok}[1]{\textcolor{lipstick}{#1}}}
\@ifundefined{PreprocessorTok}{}{\renewcommand{\PreprocessorTok}[1]{\textcolor{lipstick}{\textit{#1}}}}
\@ifundefined{RegionMarkerTok}{}{\renewcommand{\RegionMarkerTok}[1]{#1}}
\@ifundefined{SpecialCharTok}{}{\renewcommand{\SpecialCharTok}[1]{\textcolor{black}{\textbf{#1}}}}
\@ifundefined{SpecialStringTok}{}{\renewcommand{\SpecialStringTok}[1]{\textcolor{green}{#1}}}
\@ifundefined{StringTok}{}{\renewcommand{\StringTok}[1]{\textcolor{green}{#1}}}
\@ifundefined{VariableTok}{}{\renewcommand{\VariableTok}[1]{\textcolor{black}{#1}}}
\@ifundefined{VerbatimStringTok}{}{\renewcommand{\VerbatimStringTok}[1]{\textcolor{green}{#1}}}
\@ifundefined{WarningTok}{}{\renewcommand{\WarningTok}[1]{\textcolor{lipstick}{\textbf{\textit{#1}}}}}
\makeatother


% For landscape pages
\usepackage{pdflscape}
\newcommand{\blandscape}{\begin{landscape}}
\newcommand{\elandscape}{\end{landscape}}

% For the appendix table of contents
\usepackage{titletoc}

% If \MainTitle isn't already defined
\providecommand{\MainTitle}{\thetitle}

% Appendix title page malarky
\newcommand{\AppendixAutoSetup}{%
  \newpage
  \thispagestyle{empty}%
  % numbering depth for sections/ToC in appendix
  \setcounter{secnumdepth}{3}%
  \setcounter{tocdepth}{3}%
  % Appendix labels A1, A2, ... for sections, figures, tables, equations
  \renewcommand{\thesection}{A\arabic{section}}%
  \renewcommand{\thefigure}{A\arabic{figure}}%
  \setcounter{figure}{0}%
  \renewcommand{\thetable}{A\arabic{table}}%
  \setcounter{table}{0}%
  \renewcommand{\theequation}{A\arabic{equation}}%
  \setcounter{equation}{0}%
  % Title block
  \begin{center}
    {\sffamily\Large Appendix to\par}
    \vspace{0.4em}
    {\sffamily\bfseries\LARGE \MainTitle\par}
  \end{center}
  % Appendix TOC
  \startcontents[appendixtoc]%
  \begingroup
    \renewcommand{\contentsname}{\vspace{-2em}}%
    \titlecontents{section}[0em]
      {\addvspace{1em}}
      {\makebox[1em][l]{\thecontentslabel}\hspace{1em}}
      {}
      {\titlerule*[0.5pc]{.}\contentspage}
    \titlecontents{subsection}[2em]
      {\addvspace{0.5em}}
      {\makebox[2em][l]{\thecontentslabel}\hspace{1em}}
      {}
      {\titlerule*[0.5pc]{.}\contentspage}
    \titlecontents{subsubsection}[5em]
      {\addvspace{0.5em}}
      {\makebox[3em][l]{\thecontentslabel}\hspace{1em}}
      {}
      {\titlerule*[0.5pc]{.}\contentspage}
    \printcontents[appendixtoc]{1}{1}{\subsection*{\contentsname}}%
  \endgroup
  \newpage
  \setcounter{page}{1}%
}

% Apply to \appendix switch
\apptocmd{\appendix}{\AppendixAutoSetup}{}{\fail}

